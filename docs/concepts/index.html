<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.8">
<link rel="alternate" type="application/rss+xml" href="/keuss/blog/rss.xml" title="Keuss Job Queues RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/keuss/blog/atom.xml" title="Keuss Job Queues Atom Feed"><title data-react-helmet="true">Concepts | Keuss Job Queues</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://pepmartinez.github.io/keuss/keuss/docs/concepts"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Concepts | Keuss Job Queues"><meta data-react-helmet="true" name="description" content="Queue"><meta data-react-helmet="true" property="og:description" content="Queue"><link data-react-helmet="true" rel="shortcut icon" href="/keuss/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://pepmartinez.github.io/keuss/keuss/docs/concepts"><link data-react-helmet="true" rel="alternate" href="https://pepmartinez.github.io/keuss/keuss/docs/concepts" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://pepmartinez.github.io/keuss/keuss/docs/concepts" hreflang="x-default"><link rel="stylesheet" href="/keuss/assets/css/styles.61bdb3bb.css">
<link rel="preload" href="/keuss/assets/js/runtime~main.0bb687b5.js" as="script">
<link rel="preload" href="/keuss/assets/js/main.274ec513.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/keuss/"><div class="navbar__logo"><img src="/keuss/img/logo.svg" alt="Site Logo" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/keuss/img/logo.svg" alt="Site Logo" class="themedImage_1VuW themedImage--dark_hz6m"></div><b class="navbar__title">Keuss job queues</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/keuss/docs/">Docs</a><a class="navbar__item navbar__link" href="/keuss/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/pepmartinez/keuss" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_71bT toggle_3Zt9 toggleDisabled_3cF-"><div class="toggleTrack_32Fl" role="button" tabindex="-1"><div class="toggleTrackCheck_3lV7"><span class="toggleIcon_O4iE">ðŸŒœ</span></div><div class="toggleTrackX_S2yS"><span class="toggleIcon_O4iE">ðŸŒž</span></div><div class="toggleTrackThumb_xI_Z"></div></div><input type="checkbox" class="toggleScreenReader_28Tw" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_35hR" type="button"></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Intro</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/keuss/docs/">About</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/keuss/docs/quickstart">Quickstart</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/keuss/docs/concepts">Concepts</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Usage</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">API</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/keuss/docs/examples">Examples</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/keuss/docs/changelog">Changelog</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Concepts</h1></header><h2 class="anchor anchorWithStickyNavbar_31ik" id="queue">Queue<a aria-hidden="true" class="hash-link" href="#queue" title="Direct link to heading">â€‹</a></h2><p>A <strong>Queue</strong> is more of an interface, a definition of what it can do. Keuss queues are capable of:</p><ul><li>Insert one element.</li><li>Schedule an element: insert one element with a not-before datetime; this means, the element will be affectively inserted in the queue, but any operation on the queue ofter that will not take that element into account before the not-before datetime.</li><li>Get an element, and block for some specified time if no element is available.</li><li>Reserve an element, and block for some specified time if no element is available.</li><li>Commit (remove) or rollback (return back) a previously reserved element.</li><li>Remove an element by its id (which was returned in the insertion)</li><li>Get element count (it will not include the elements scheduled in the future).</li><li>Get element count whose not-before datetime is in the future (scheduled elements).</li><li>Get usage stats: elements inserted, elements extracted.</li></ul><p><em>Element</em> here translates to any js object, js array, string, number or <code>Buffer</code>. Optionally, a set of headers (in the form of a js object with string, number or boolean values) can be added.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="bucket">Bucket<a aria-hidden="true" class="hash-link" href="#bucket" title="Direct link to heading">â€‹</a></h2><p>The initial idea for Keuss Queues, transtated the elements inserted in the queue into rows of the backed storage. This makes it easy to inspect the elements values directly in the backend, which is pretty useful when you need to debug things up. Buckets came later, as a way to pack more than one message into a single row of the backend to gain performance. See <a href="/keuss/docs/usage/buckets">Bucked-based backends</a>.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="pipeline">Pipeline<a aria-hidden="true" class="hash-link" href="#pipeline" title="Direct link to heading">â€‹</a></h2><p>A <strong><a href="/keuss/docs/usage/pipelines/about">pipeline</a></strong> is an enhanced queue that provides an extra operation: pass an element to another queue <strong>atomically</strong>. In an scenario where processors are linked with queues, it is usually a good feature to allow the <em>&#x27;commit element in incoming queue, insert element in the next queue&#x27;</em> to be atomic. This removes chances for race conditions, or message losses.</p><p>The pipeline concept is, indeed, an extension of the reserve-commit model; it is so far implemented only atop mongodb, and it is anyway considered as a &#x27;low-level&#x27; feature, best used by means of specialized classes to encapsulate the aforementioned processors.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="processor">Processor<a aria-hidden="true" class="hash-link" href="#processor" title="Direct link to heading">â€‹</a></h2><p>A <strong>processor</strong> is an object tied to one or more queues, that controls the flow of messages between them. They are used mainly to define <a href="/keuss/docs/usage/pipelines/about"><strong>pipelines</strong></a>. Currently there are 4 specialized classes of processors defined:</p><ul><li><a href="/keuss/docs/usage/pipelines/processors#baselink">BaseLink</a>: This is really more of a base definition for the rest of the specialized processors.</li><li><a href="/keuss/docs/usage/pipelines/processors#directlink">DirectLink</a> (one queue to another).</li><li><a href="/keuss/docs/usage/pipelines/processors#choicelink">ChoiceLink</a> (one queue to one or more queues).</li><li><a href="/keuss/docs/usage/pipelines/processors#sink">Sink</a> (endpoint, one queue to none).</li></ul><h2 class="anchor anchorWithStickyNavbar_31ik" id="storage">Storage<a aria-hidden="true" class="hash-link" href="#storage" title="Direct link to heading">â€‹</a></h2><p>The <strong>Storage</strong> or <strong>Backend</strong> provides almost-complete queue primitives, fully functional and already usable as is. Keuss comes with 7 backends, with various levels of features and performance:</p><ul><li><em><code>mongo</code></em>, a mongodb-based backend that provides the full set of queue features, still with decent performance.</li><li><em><code>redis-oq</code></em>, backed using an ordered queue on top of redis (made in turn with a sorted set, a hash and some lua). Provides all queue features including reserve-commit-rollback. Noticeable faster than mongodb.</li><li><em><code>redis-list</code></em>, backed using a redis list. Does not offer reserve-commit-rollback nor the ability to schedule, but is much faster than redis-oq</li><li><em><code>pl-mongo</code></em>, a version of the <em><code>mongo</code></em> backend that provides pipelining capabilities (the queues it produces are also pipelines).</li><li><em><code>ps-mongo</code></em>, a version of the <em><code>mongo</code></em> backend where elements are not physically deleted from the collection when extracted; instead, they are just marked as processed and later deleted automatically using a mongodb TTL index.</li><li><em><code>bucket-mongo</code></em>, a first attepmt on storing more than one element on each mongodb record in order to break past mongodb I/O limitations. It is very simple, lacking schedule and reserve support. However, it has staggering throughput on a reasonable durability.</li><li><em><code>bucket-mongo-safe</code></em>, an evolution of <em><code>bucket-mongo</code></em>, provides both scheduling and reserve support with a performance only a bit below <em><code>bucket-mongo</code></em>.</li></ul><p>As mentioned before, persistence and High Availability (HA) depends exclusively on the underliying system: mongodb provides production-grade HA and persistence while using potentially gigantic queues, and with redis one can balance performance and simplicity over reliability and durability, by using standalone redis, redis sentinel or redis cluster. Keuss uses <a href="https://github.com/luin/ioredis" target="_blank" rel="noopener noreferrer">ioredis</a> as redis driver, which supports all 3 cases.</p><p>The following table shows the capabilities of each backend:</p><table><thead><tr><th>backend</th><th align="center">delay/schedule</th><th align="center">reserve/commit</th><th align="center">pipelining</th><th align="center">history</th><th align="center">remove</th><th align="center">throughput</th></tr></thead><tbody><tr><td>redis-list</td><td align="center">-</td><td align="center">-</td><td align="center">-</td><td align="center">-</td><td align="center">-</td><td align="center">++++</td></tr><tr><td>redis-oq</td><td align="center">x</td><td align="center">x</td><td align="center">-</td><td align="center">-</td><td align="center">x</td><td align="center">+++</td></tr><tr><td>mongo</td><td align="center">x</td><td align="center">x</td><td align="center">-</td><td align="center">-</td><td align="center">x</td><td align="center">++</td></tr><tr><td>pl-mongo</td><td align="center">x</td><td align="center">x</td><td align="center">x</td><td align="center">-</td><td align="center">x</td><td align="center">+</td></tr><tr><td>ps-mongo</td><td align="center">x</td><td align="center">x</td><td align="center">-</td><td align="center">x</td><td align="center">x</td><td align="center">++</td></tr><tr><td>bucket-mongo</td><td align="center">-</td><td align="center">-</td><td align="center">-</td><td align="center">-</td><td align="center">-</td><td align="center">+++++</td></tr><tr><td>bucket-mongo-safe</td><td align="center">x</td><td align="center">x</td><td align="center">-</td><td align="center">-</td><td align="center">x</td><td align="center">+++++</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_31ik" id="signaller">Signaller<a aria-hidden="true" class="hash-link" href="#signaller" title="Direct link to heading">â€‹</a></h2><p><strong>Signaller</strong> provides a bus interconnecting all keuss clients, so events can be shared. Keuss provides 3 signallers:</p><ul><li><em><code>local</code></em> : provides in-proccess messaging, useful only for simple cases or testing</li><li><em><code>redis-pubsub</code></em>: uses the pubsub subsystem provided by redis</li><li><em><code>mongo-capped</code></em>: uses pubsub on top of a mongodb capped collection, using <a href="https://www.npmjs.com/package/@nodebb/mubsub" target="_blank" rel="noopener noreferrer">@nodebb/mubsub</a></li></ul><p>So far, the only events published by keuss are:</p><ul><li><em>element inserted in queue X</em>, which allows other clients waiting for elements to be available to wake up and retry. A client will not fire an event if
another one of the same type (same client, same queue) was already fired less than 50ms ago.</li><li><em>queue X paused/resumed</em>.</li></ul><p>The use of a signaller provider different from <code>local</code> allows the formation of a cluster of clients: all those clients sharing the same signaller object
(with the same configuration, obviously) will see and share the same set of events and therefore can collaborate (for example, all consumers of a given
queue <em>on every machine</em> will be awaken when an insertion happens <em>on any machine</em>)</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="stats">Stats<a aria-hidden="true" class="hash-link" href="#stats" title="Direct link to heading">â€‹</a></h2><p><strong>Stats</strong> provides counters and metrics on queues, shared among keuss clients. The supported stats are:</p><ul><li>Elements put</li><li>Elements got</li><li>Elements reserved</li><li>Elements committed</li><li>Elements rolled back</li><li>Paused status</li></ul><p>Three options are provided to store the stats:</p><ul><li><em><code>mem</code></em>: very simple in-process, memory based.</li><li><em><code>redis</code></em>: backed by redis hashes. Modifications are buffered in memory and flushed every 100ms.</li><li><em><code>mongo</code></em>: backed by mongodb using one object per queue inside a single collection. Modifications are buffered in memory and flushed every 100ms.</li></ul><p>The use of a stats provider different from <code>mem</code> allows for a shared view of a cluster of clients: all those clients sharing the same stats object
(with the same configuration, obviously) will see a coherent, aggregated view of the stats (all clients will update the stats)</p><p>The stats can also be used as a queue discovery source: existing queues can be recreated from the information stored (in fact, extra information
needed to ensure this is also stored alongside the actual stats). Keuss does not, at this point, provide any actual <em>recreate</em> functionality on
top of this</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="how-all-fits-together">How all fits together<a aria-hidden="true" class="hash-link" href="#how-all-fits-together" title="Direct link to heading">â€‹</a></h2><ul><li><em><code>Queues</code></em>, or rather clients to individual queues, are created using a <em>backend</em> as factory.</li><li><em><code>Backends</code></em> need to be initialized before being used. Exact initialization details depend on each backend.</li><li>When creating a <em><code>queue</code></em>, a <em><code>signaller</code></em> and a <em><code>stats</code></em> are assigned to it. The actual class/type to be used can be specified at the queue&#x27;s creation moment, or at the backend initialization moment. By default <em><code>local</code></em> and <em><code>mem</code></em>, respectively, are used for redis-based backends; for mongodb-based backends, <em><code>mongo-capped</code></em> and <em><code>mongo</code></em> are used intead as defaults</li><li><em><code>Queues</code></em> are created on-demand, and are never destroyed as far as Keuss is concerned. They do exist as long as the underlying backend kepts them in existence: for example, redis queues dissapear as such when they become empty.</li><li><em><code>Pipelines</code></em> are, strictly speaking, just enhanced queues; as such they behave and can be used as a queue. More info on pipelines <a href="/keuss/docs/usage/pipelines/about">here</a></li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/pepmartinez/keuss/edit/master/website/docs/concepts.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/keuss/docs/quickstart"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« <!-- -->Quickstart</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/keuss/docs/usage/putting-all-together"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Putting all together<!-- --> Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#queue" class="table-of-contents__link toc-highlight">Queue</a></li><li><a href="#bucket" class="table-of-contents__link toc-highlight">Bucket</a></li><li><a href="#pipeline" class="table-of-contents__link toc-highlight">Pipeline</a></li><li><a href="#processor" class="table-of-contents__link toc-highlight">Processor</a></li><li><a href="#storage" class="table-of-contents__link toc-highlight">Storage</a></li><li><a href="#signaller" class="table-of-contents__link toc-highlight">Signaller</a></li><li><a href="#stats" class="table-of-contents__link toc-highlight">Stats</a></li><li><a href="#how-all-fits-together" class="table-of-contents__link toc-highlight">How all fits together</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Start Here</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/keuss/docs/quickstart">Quickstart</a></li><li class="footer__item"><a class="footer__link-item" href="/keuss/docs/">Documentation</a></li><li class="footer__item"><a class="footer__link-item" href="/keuss/docs/examples">Examples</a></li><li class="footer__item"><a class="footer__link-item" href="/keuss/docs/changelog">ChangeLog</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/keuss/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/pepmartinez/keuss" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021. Built with Docusaurus.</div></div></div></footer></div>
<script src="/keuss/assets/js/runtime~main.0bb687b5.js"></script>
<script src="/keuss/assets/js/main.274ec513.js"></script>
</body>
</html>