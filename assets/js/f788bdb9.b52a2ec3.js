"use strict";(self.webpackChunkkeuss_docusaurus=self.webpackChunkkeuss_docusaurus||[]).push([[2680],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>c});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,l=e.originalType,s=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),m=p(n),c=r,k=m["".concat(s,".").concat(c)]||m[c]||d[c]||l;return n?a.createElement(k,i(i({ref:t},u),{},{components:n})):a.createElement(k,i({ref:t},u))}));function c(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=n.length,i=new Array(l);i[0]=m;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o.mdxType="string"==typeof e?e:r,i[1]=o;for(var p=2;p<l;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},5522:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>d,frontMatter:()=>l,metadata:()=>o,toc:()=>p});var a=n(7462),r=(n(7294),n(3905));const l={id:"queue",title:"Queue API",sidebar_label:"Queue"},i=void 0,o={unversionedId:"API/queue",id:"API/queue",title:"Queue API",description:"stats: Queue stats",source:"@site/docs/06-API/queue.md",sourceDirName:"06-API",slug:"/API/queue",permalink:"/keuss/docs/API/queue",draft:!1,editUrl:"https://github.com/pepmartinez/keuss/edit/master/website/docs/06-API/queue.md",tags:[],version:"current",frontMatter:{id:"queue",title:"Queue API",sidebar_label:"Queue"},sidebar:"tutorialSidebar",previous:{title:"Factory",permalink:"/keuss/docs/API/factory"},next:{title:"Signaller",permalink:"/keuss/docs/API/signal"}},s={},p=[{value:"<code>stats</code>: Queue stats",id:"stats-queue-stats",level:3},{value:"<code>name</code>: Queue name",id:"name-queue-name",level:3},{value:"<code>type</code>: Queue type",id:"type-queue-type",level:3},{value:"<code>size</code>: Queue occupation",id:"size-queue-occupation",level:3},{value:"<code>totalSize</code>: Total queue occupation",id:"totalsize-total-queue-occupation",level:3},{value:"<code>schedSize</code>: Size of Scheduled",id:"schedsize-size-of-scheduled",level:3},{value:"<code>resvSize</code>: Reserved elements size",id:"resvsize-reserved-elements-size",level:3},{value:"<code>pause</code> / <code>paused</code>: Pause/Resume",id:"pause--paused-pauseresume",level:3},{value:"<code>next_t</code>: Time of schedule of next message",id:"next_t-time-of-schedule-of-next-message",level:3},{value:"<code>push</code>: Add element to queue",id:"push-add-element-to-queue",level:3},{value:"<code>pop</code>: Get element from queue",id:"pop-get-element-from-queue",level:3},{value:"<code>cancel</code>: Cancel a pending Pop",id:"cancel-cancel-a-pending-pop",level:3},{value:"<code>ok</code>: Commit a reserved element",id:"ok-commit-a-reserved-element",level:3},{value:"<code>ko</code>: Roll back a reserved element",id:"ko-roll-back-a-reserved-element",level:3},{value:"<code>remove</code>: Delete elements from queue by id",id:"remove-delete-elements-from-queue-by-id",level:3},{value:"<code>drain</code>: Drain queue",id:"drain-drain-queue",level:3}],u={toc:p};function d(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h3",{id:"stats-queue-stats"},(0,r.kt)("inlineCode",{parentName:"h3"},"stats"),": Queue stats"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"q.stats ((err, res) => {\n  ...\n})\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"res")," contains usage statistics (elements inserted, elements extracted, paused status).")),(0,r.kt)("h3",{id:"name-queue-name"},(0,r.kt)("inlineCode",{parentName:"h3"},"name"),": Queue name"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"var qname = q.name ()\n")),(0,r.kt)("h3",{id:"type-queue-type"},(0,r.kt)("inlineCode",{parentName:"h3"},"type"),": Queue type"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"var qtype = q.type ()\n")),(0,r.kt)("p",null,"Returns a string with the type of the queue (the type of backend which was used to create it)."),(0,r.kt)("h3",{id:"size-queue-occupation"},(0,r.kt)("inlineCode",{parentName:"h3"},"size"),": Queue occupation"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"q.size ((err, res) => {\n  ...\n})\n")),(0,r.kt)("p",null,"Returns the number of elements in the queue that are already elligible (that is, excluding scheduled elements with a schedule time in the future)."),(0,r.kt)("h3",{id:"totalsize-total-queue-occupation"},(0,r.kt)("inlineCode",{parentName:"h3"},"totalSize"),": Total queue occupation"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"q.totalSize ((err, res) => {\n  ...\n})\n")),(0,r.kt)("p",null,"Returns the number of elements in the queue (that is, including scheduled elements with a schedule time in the future)."),(0,r.kt)("h3",{id:"schedsize-size-of-scheduled"},(0,r.kt)("inlineCode",{parentName:"h3"},"schedSize"),": Size of Scheduled"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"q.schedSize ((err, res) => {\n  ...\n})\n")),(0,r.kt)("p",null,"Returns the number of scheduled elements in the queue (that is, those with a schedule time in the future). Returns 0 if the queue does not support scheduling."),(0,r.kt)("h3",{id:"resvsize-reserved-elements-size"},(0,r.kt)("inlineCode",{parentName:"h3"},"resvSize"),": Reserved elements size"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"q.resvSize ((err, res) => {\n  ...\n})\n")),(0,r.kt)("p",null,"Returns the number of reserved elements in the queue. Returns ",(0,r.kt)("inlineCode",{parentName:"p"},"null")," if the queue does not support reserve."),(0,r.kt)("h3",{id:"pause--paused-pauseresume"},(0,r.kt)("inlineCode",{parentName:"h3"},"pause")," / ",(0,r.kt)("inlineCode",{parentName:"h3"},"paused"),": Pause/Resume"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"// pauses the queue\nq.pause (true)\n\n// resumes the queue\nq.pause (false)\n\n// gets paused status of queue\nq.paused ((err, is_paused) => {\n  ...\n})\n")),(0,r.kt)("p",null,"Pauses/Resumes all consumers on this queue (calls to ",(0,r.kt)("inlineCode",{parentName:"p"},"pop()"),"). Producers are not afected (calls to ",(0,r.kt)("inlineCode",{parentName:"p"},"push()"),")."),(0,r.kt)("p",null,"The pause/resume condition is propagated via the signallers, so this affects all consumers, not only those local to the process, if a redis-pubsub or mongo-capped signaller is used."),(0,r.kt)("p",null,"Also, the paused condition is stored as stats, so any new call to ",(0,r.kt)("inlineCode",{parentName:"p"},"pop()")," will honor it."),(0,r.kt)("h3",{id:"next_t-time-of-schedule-of-next-message"},(0,r.kt)("inlineCode",{parentName:"h3"},"next_t"),": Time of schedule of next message"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"q.next_t ((err, res) => {\n  ...\n})\n")),(0,r.kt)("p",null,"Returns a ",(0,r.kt)("inlineCode",{parentName:"p"},"Date"),", or ",(0,r.kt)("inlineCode",{parentName:"p"},"null")," if queue is empty. Queues with no support for schedule/delay always return `null"),(0,r.kt)("h3",{id:"push-add-element-to-queue"},(0,r.kt)("inlineCode",{parentName:"h3"},"push"),": Add element to queue"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"q.push (payload, [opts,] (err, res) => {\n  ...\n})\n")),(0,r.kt)("p",null,"Adds payload to the queue and calls passed callback upon completion. Callback's ",(0,r.kt)("em",{parentName:"p"},"res")," will contain the id assigned to the inserted element, if the backup provides one."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"payload")," can be an ",(0,r.kt)("inlineCode",{parentName:"p"},"object"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"array"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"string"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"number")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"Buffer")),(0,r.kt)("p",null,"Possible opts:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"mature"),": unix timestamp where the element would be elligible for extraction. It is guaranteed that the element won't be extracted before this time."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"delay"),": delay in seconds to calculate the mature timestamp, if mature is not provided. For example, a delay=120 guarantees the element won't be extracted until 120 secs have elapsed ",(0,r.kt)("em",{parentName:"li"},"at least"),"."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"tries"),": value to initialize the retry counter, defaults to 0 (still no retries)."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"hdrs"),": object with scalar-valued keys (ie, string, number or boolean) to be added alongside the ",(0,r.kt)("inlineCode",{parentName:"li"},"payload")," as general purpose headers")),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},(0,r.kt)("strong",{parentName:"p"},"mature")," and ",(0,r.kt)("strong",{parentName:"p"},"delay")," have no effect if the backend does not support delay/schedule.")),(0,r.kt)("h3",{id:"pop-get-element-from-queue"},(0,r.kt)("inlineCode",{parentName:"h3"},"pop"),": Get element from queue"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"var tr = q.pop (cid, [opts,] (err, res) => {\n  ...\n})\n")),(0,r.kt)("p",null,"Obtains an element from the queue. Callback is called with the element obtained if any, or if an error happened. If defined, the operation will wait for ",(0,r.kt)("inlineCode",{parentName:"p"},"opts.timeout")," seconds for an element to appear in the queue before bailing out (with both ",(0,r.kt)("inlineCode",{parentName:"p"},"err")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"res")," being null). However, it immediately returns an id that can be used to cancel the operation at anytime."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"*cid*")," is an string that identifies the consumer entity; it is used only for debugging purposes."),(0,r.kt)("p",null,"Possible opts:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"timeout"),": milliseconds to wait for an elligible element to appear in the queue to be returned. If not defined it will wait forever"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"reserve"),": if ",(0,r.kt)("inlineCode",{parentName:"li"},"true")," the element is only reserved, not completely returned. This means either ",(0,r.kt)("em",{parentName:"li"},"ok")," or ",(0,r.kt)("em",{parentName:"li"},"ko")," operations are needed upon the obtained element once processed, otherwise the element will be rolled back (and made available again) at some point in the future (this is only available on backends capable of reserve/commit).")),(0,r.kt)("h3",{id:"cancel-cancel-a-pending-pop"},(0,r.kt)("inlineCode",{parentName:"h3"},"cancel"),": Cancel a pending Pop"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"var tr = q.pop (cid, opts, (err, res) => {...});\n.\n.\n.\nq.cancel (tr);\n")),(0,r.kt)("p",null,"Cancels a pending ",(0,r.kt)("inlineCode",{parentName:"p"},"pop")," operation, identified by the value returned by ",(0,r.kt)("inlineCode",{parentName:"p"},"pop()")),(0,r.kt)("p",null,"If no ",(0,r.kt)("inlineCode",{parentName:"p"},"tr")," param is passed, or it is ",(0,r.kt)("inlineCode",{parentName:"p"},"null"),", all pending ",(0,r.kt)("inlineCode",{parentName:"p"},"pop")," operations on the queue are cancelled. Cancelled ",(0,r.kt)("inlineCode",{parentName:"p"},"pop")," operations will get ",(0,r.kt)("inlineCode",{parentName:"p"},"'cancel'")," (a string) in the ",(0,r.kt)("inlineCode",{parentName:"p"},"error")," parameter value of the callback."),(0,r.kt)("h3",{id:"ok-commit-a-reserved-element"},(0,r.kt)("inlineCode",{parentName:"h3"},"ok"),": Commit a reserved element"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"q.ok (id|obj, (err, res) => {\n  ...\n})\n")),(0,r.kt)("p",null,"Commits a reserved element by its id (the id would be assigned to ",(0,r.kt)("inlineCode",{parentName:"p"},"res._id")," on the ",(0,r.kt)("inlineCode",{parentName:"p"},"res")," param of ",(0,r.kt)("inlineCode",{parentName:"p"},"pop()")," operation) or specifying the entire\nobject (as it was returned by the reserve call). This effectively erases the element from the queue."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"const tr = q.pop ('my-consumer-id', {reserve: true}, (err, res) => {\n  // do something with res\n  ...\n\n  // alternative 1: commit it by id\n  q.ok (res._id, (err, res) => {\n    ...\n  });\n\n  // alternative 2: commit it by full object\n  q.ok (res, (err, res) => {\n    ...\n  });\n});\n")),(0,r.kt)("h3",{id:"ko-roll-back-a-reserved-element"},(0,r.kt)("inlineCode",{parentName:"h3"},"ko"),": Roll back a reserved element"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"q.ko (id|obj, next_t, (err, res) => {\n  ...\n})\n")),(0,r.kt)("p",null,"Rolls back a reserved element by its id (the id would be at ",(0,r.kt)("inlineCode",{parentName:"p"},"res._id")," on the ",(0,r.kt)("inlineCode",{parentName:"p"},"res")," param of ",(0,r.kt)("inlineCode",{parentName:"p"},"pop()")," operation) or specifying the entire\nobject (as it was returned by the reserve call). This effectively makes the element available again at the queue, marking it to be\nmature at ",(0,r.kt)("inlineCode",{parentName:"p"},"next_t")," (",(0,r.kt)("inlineCode",{parentName:"p"},"next_t")," being a millsec-unixtime). If no ",(0,r.kt)("inlineCode",{parentName:"p"},"next_t")," is specified or a ",(0,r.kt)("inlineCode",{parentName:"p"},"null")," is passed, ",(0,r.kt)("inlineCode",{parentName:"p"},"now()")," is assumed."),(0,r.kt)("p",null,"the ",(0,r.kt)("inlineCode",{parentName:"p"},"res")," param of the callback can take the following values:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"true")," if all went ok and an element was in fact rolled back"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"nullish")," if the element does not exist in the queue"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"'deadletter'")," (as string) if the rollback resulted in the element being moved to deadletter ")),(0,r.kt)("p",null,"As with ",(0,r.kt)("inlineCode",{parentName:"p"},"ok()"),", you can pass the entire reserved object as ",(0,r.kt)("inlineCode",{parentName:"p"},"id"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"const tr = q.pop ('my-consumer-id', {reserve: true}, (err, res) => {\n  // do something with res\n  ...\n\n  // commit or rollback it\n  if (succeed) q.ok (res, (err, res) => {\n    ...\n  })\n  else q.ko (res, (err, res) => {\n    if (res === 'deadletter') {\n      // moved to deadletter\n      ...\n    }\n    ...\n  })\n});\n")),(0,r.kt)("admonition",{type:"important"},(0,r.kt)("p",{parentName:"admonition"},"You must pass the entire ",(0,r.kt)("inlineCode",{parentName:"p"},"res")," object for the ",(0,r.kt)("a",{parentName:"p",href:"../api/factory#dead-letter"},"deadletter")," feature to work; even if activated at the factory, ",(0,r.kt)("inlineCode",{parentName:"p"},"ko()")," will not honor deadletter if you only pass the ",(0,r.kt)("inlineCode",{parentName:"p"},"res._id")," as ",(0,r.kt)("inlineCode",{parentName:"p"},"id"),".")),(0,r.kt)("h3",{id:"remove-delete-elements-from-queue-by-id"},(0,r.kt)("inlineCode",{parentName:"h3"},"remove"),": Delete elements from queue by id"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"q.remove (id, (err, res) => {\n  ...\n})\n")),(0,r.kt)("p",null,"Removes an element from a queue, by using the id returned at insertion time (backends supporting ",(0,r.kt)("inlineCode",{parentName:"p"},"remove")," will return an in upon insertion). A reserved element can not be removed, and will be considered as nonexistent"),(0,r.kt)("p",null,"the ",(0,r.kt)("inlineCode",{parentName:"p"},"res")," param of the callback can take the following values:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"true")," if all went ok and the element was removed"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"nullish")," if the element does not exist in the queue")),(0,r.kt)("h3",{id:"drain-drain-queue"},(0,r.kt)("inlineCode",{parentName:"h3"},"drain"),": Drain queue"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"q.drain (err => {\n  ...\n})\n")),(0,r.kt)("p",null,"Drains a queue. This is a needed operation when a backend does read-ahead upon a ",(0,r.kt)("inlineCode",{parentName:"p"},"pop()"),", or buffers ",(0,r.kt)("inlineCode",{parentName:"p"},"push()")," operations for later; in this case, you may want to be sure that all extra elemens read are actually popped, and all pending pushes are committed."),(0,r.kt)("admonition",{type:"warning"},(0,r.kt)("p",{parentName:"admonition"},"'drain' will immediately inhibit ",(0,r.kt)("inlineCode",{parentName:"p"},"push()"),": any call to ",(0,r.kt)("inlineCode",{parentName:"p"},"push()")," will immediately result in a ",(0,r.kt)("inlineCode",{parentName:"p"},"'drain'")," (a string)  in the ",(0,r.kt)("inlineCode",{parentName:"p"},"error")," parameter value of the callback. The callback will be called when all pending pushes are committed, and all read-ahead on a pop() has been actually popped.")),(0,r.kt)("p",null,"Also, ",(0,r.kt)("inlineCode",{parentName:"p"},"drain()")," will also call ",(0,r.kt)("inlineCode",{parentName:"p"},"cancel()")," on the queue immediately before finishing, in case of success."))}d.isMDXComponent=!0}}]);